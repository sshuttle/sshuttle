#!/usr/bin/env bash
set -euo pipefail

# This script brings up the test-bed, installs server.yaml on node-1,
# runs sshuttle with a selected profile, exercises allowed/blocked flows,
# and checks the server log for syslog-style entries.

here="$(cd "$(dirname "$0")" && pwd)"
root="$(cd "$here/.." && pwd)"

server_yaml="$root/docs/examples/server.yaml"
profile_name="testing"
log_path="/var/log/sshuttle/default.jsonl"

echo "Bringing up test-bed (building image if needed)..."
"$here/test-bed" up -d --build

# Determine node-1 IP to use for scp and ssh
node_ip=$("$here/test-bed" get-ip node-1)

# Prepare passwordless SSH: generate ephemeral key and install on node-1
keydir="$(mktemp -d)"
keyfile="$keydir/id_ed25519"
ssh-keygen -t ed25519 -N '' -f "$keyfile" -q
container_name="sshuttle-testbed-node-1"
echo "Installing our pubkey into $container_name authorized_keys for user 'test'"
docker exec -u root "$container_name" sh -lc 'install -d -m 700 -o test -g test /home/test/.ssh && touch /home/test/.ssh/authorized_keys && chown test:test /home/test/.ssh/authorized_keys && chmod 600 /home/test/.ssh/authorized_keys'
docker exec -i "$container_name" sh -lc 'cat >> /home/test/.ssh/authorized_keys' <"$keyfile.pub"

# Copy server.yaml into container and place at /etc/sshuttle/server.yaml
# Use docker cp for simplicity
echo "Ensuring /etc/sshuttle exists inside container"
docker exec -u root "$container_name" mkdir -p /etc/sshuttle

echo "Installing server.yaml into $container_name:/etc/sshuttle/server.yaml"
docker cp "$server_yaml" "$container_name:/etc/sshuttle/server.yaml"

echo "Ensuring log directory exists and is writable inside container"
docker exec -u root "$container_name" sh -lc 'mkdir -p /var/log/sshuttle && chown test:test /var/log/sshuttle'

# Start sshuttle from host, connecting to node-1 as server
# Use profile and route a known subnet. We'll test allowed flows and check logs.

set -x
export SSH_IDENTITY_FILE="$keyfile"
SSH_AUTH_SOCK='' XDG_RUNTIME_DIR='' \
"$here/exec-sshuttle" node-1 --profile "$profile_name" -v -v \
  --sshuttle-bin=dev -- "10.55.0.0/16" &
shuttle_pid=$!
set +x

echo "Waiting a few seconds for sshuttle to connect..."
sleep 5

# Test allowed: iperf3 to node-2:5001 (allowed per testing profile)
set -x
"$here/exec-tool" iperf3 node-2 || true
set +x

# Show log entries
echo "Checking log entries in container at $log_path"
docker exec "$container_name" sh -lc "test -f '$log_path' && tail -n +1 '$log_path' || true"

# Cleanup
kill "$shuttle_pid" 2>/dev/null || true
wait "$shuttle_pid" 2>/dev/null || true

echo "Done."

